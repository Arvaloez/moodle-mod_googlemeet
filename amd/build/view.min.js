function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}f(void 0)})}}define ("mod_googlemeet/view",["core/ajax","core/str","core/notification","core/templates","mod_googlemeet/gapi"],function(a,b,c,d,e){return{init:function init(f,g,h,i,j,k){var z=["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],A=h.url.substr(24,12),B,C="",D="",E="",F="";b.get_strings([{key:"notpossiblesync",component:"mod_googlemeet"},{key:"notfoundrecordingsfolder",component:"mod_googlemeet"},{key:"notfoundrecordingname",component:"mod_googlemeet"},{key:"or",component:"mod_googlemeet"}]).done(function(a){C=a[0];D=a[1];E=a[2];F=a[3]}).fail(c.exception);var G=document.getElementById("id_syncdrivebutton");function l(){return m.apply(this,arguments)}function m(){m=_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.next=2;return e.auth2.getAuthInstance().signIn({prompt:"select_account"});case 2:x();case 3:case"end":return a.stop();}}},a)}));return m.apply(this,arguments)}function n(a){var b=document.getElementById("googlemeet_syncimg");if(a){b.style.display="flex";G.disabled=!0}else{b.style.display="none";G.disabled=!1}}function o(a){var b=document.getElementById("googlemeetcontentlog"),c=document.createTextNode(a+"\n");b.style.display="block";b.appendChild(c)}function p(){var a=document.getElementById("googlemeetcontentlog");a.style.display="none";a.innerHTML=""}function q(){return r.apply(this,arguments)}function r(){r=_asyncToGenerator(regeneratorRuntime.mark(function a(b){return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.next=2;return e.client.drive.permissions.create({resource:{type:"anyone",role:"reader"},fileId:b,fields:"id"});case 2:case"end":return a.stop();}}},a)}));return r.apply(this,arguments)}function s(){var a="and (name contains '"+A+"'";a+=" or name contains '"+h.originalname+"')";return a}function t(a){var b=Math.floor(parseInt(a,10)/1e3),c=Math.floor(b/3600),d=Math.floor((b-3600*c)/60),e=b-3600*c-60*d;if(10>e){e="0"+e}if(0<c){if(10>d){d="0"+d}return c+":"+d+":"+e}else{return d+":"+e}}function u(a){d.render("mod_googlemeet/recordingstable",{recordings:a,coursemoduleid:j,hascapability:k}).then(function(a,b){n(!1);d.replaceNodeContents("#googlemeet_recordings_table",a,b);document.getElementById("id_creatoremail").innerHTML=B;document.getElementById("id_lastsync").innerHTML=new Date().toLocaleString().substr(0,16)}).fail(c.exception).fail(function(){n(!1)})}function v(){return w.apply(this,arguments)}function w(){w=_asyncToGenerator(regeneratorRuntime.mark(function b(d){var f,g,k,l,m;return regeneratorRuntime.wrap(function(b){while(1){switch(b.prev=b.next){case 0:b.next=2;return e.client.drive.files.list({q:"parents='"+d+"' and trashed=false and mimeType='video/mp4' "+s(),pageSize:1e3,fields:"files(id,name,permissionIds,createdTime,videoMediaMetadata,webViewLink)"});case 2:f=b.sent;g=f.result.files;if(g&&0<g.length){for(k=0;k<g.length;k++){l=g[k];if(!l.permissionIds.includes("anyoneWithLink")){q(l.id)}g[k].recordingId=l.id;g[k].duration=t(l.videoMediaMetadata.durationMillis);g[k].createdTime=Math.floor(new Date(l.createdTime).getTime()/1e3);delete g[k].id;delete g[k].permissionIds;delete g[k].videoMediaMetadata}a.call([{methodname:"mod_googlemeet_sync_recordings",args:{googlemeetid:h.id,creatoremail:B,files:g,coursemoduleid:j}}])[0].then(function(a){u(a);i=!0;return}).fail(c.exception).fail(function(){n(!1)})}else{if(i){a.call([{methodname:"mod_googlemeet_delete_all_recordings",args:{googlemeetid:h.id,coursemoduleid:j}}])[0].then(function(a){u(a);i=!1;return}).fail(c.exception).fail(function(){n(!1)})}m=E+" \""+A+"\" ";if(h.originalname){m+=F+" \""+h.originalname+"\""}o(m);n(!1)}case 5:case"end":return b.stop();}}},b)}));return w.apply(this,arguments)}function x(){return y.apply(this,arguments)}function y(){y=_asyncToGenerator(regeneratorRuntime.mark(function a(){var b,c;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:n(!0);p();a.next=4;return e.client.drive.files.list({q:"name='Meet Recordings'",pageSize:100,fields:"nextPageToken, files(id,owners)"});case 4:b=a.sent;c=b.result.files;if(!(c&&0<c.length)){a.next=15;break}if(!(!h.creatoremail||h.creatoremail===c[0].owners[0].emailAddress)){a.next=11;break}B=c[0].owners[0].emailAddress;v(c[0].id);return a.abrupt("return");case 11:o(C);n(!1);a.next=17;break;case 15:o(D);n(!1);case 17:case"end":return a.stop();}}},a)}));return y.apply(this,arguments)}e.load("client:auth2",function(){e.client.init({apiKey:g,clientId:f,discoveryDocs:z,scope:"https://www.googleapis.com/auth/drive"}).then(function(){G.onclick=l;G.disabled=!1}).catch(function(a){G.disabled=!0;o(JSON.stringify(a,null,2))})})}}});
//# sourceMappingURL=view.min.js.map
